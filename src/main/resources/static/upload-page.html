
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upload and Fetch Leave Data</title>
<link rel="stylesheet" href="style.css">
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.0/xlsx.full.min.js"></script>
<!-- Include SheetJS library -->
<script src="/jsPDF-1.3.2/dist/jspdf.min.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
	<h1>Upload Leave Data</h1>
	<div id="uploadFormContainer">
		<form id="uploadForm">
			<label for="file">Select XLS File:</label> <input type="file"
				id="file" name="file" accept=".xls,.xlsx" required> <br>
			<label for="template">Select Template:</label> <select id="template"
				name="template">
				<option value="leave">Leave Report</option>
				<option value="timesheet">Timesheet</option>
			</select> <br>
			<button type="submit">Upload</button>
		</form>
	</div>

	<div id="leaveReportContainer" style="display: none;">
		<h2>Fetch Leave Report</h2>
		<label for="templateName">Select Template:</label>
        <select id="templateName">
            <option value="leaveReport">Leave Report</option>
            <option value="timesheet">Timesheet</option>
        </select>

        <label for="reportMonth">Select Month:</label>
        <select id="reportMonth">
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
        </select>

        <button id="generateReport">Generate</button>
        <button id="downloadLeaveReport">Download PDF</button>

        <table id="reportTable">
            <!-- Table headers and data will be dynamically populated -->
        </table>
    </div>

	<button id="logoutButton">Logout</button>

	<script>
	document.getElementById('uploadForm').addEventListener('submit', function(event) {
	    event.preventDefault(); // Prevent default form submission

	    // Retrieve selected file
	    const fileInput = document.getElementById('file');
	    const file = fileInput.files[0];

	    // Validate file selection
	    if (!file) {
	        alert('Please select a file.');
	        return;
	    }

	    // Retrieve selected template
	    const templateSelect = document.getElementById('template');
	    const selectedTemplate = templateSelect.value;
	    
	    
	    // Check if the selected template matches the file type
	    if (selectedTemplate === 'timesheet' && !file.name.toLowerCase().includes('timesheet')) {
	        alert('Please select a Timesheet file for the Timesheet template.');
	        return;
	    } else if (selectedTemplate === 'leave' && !file.name.toLowerCase().includes('leave')) {
	        alert('Please select a Leave Report file for the Leave Report template.');
	        return;
	    }

	    // Read file content
	    const reader = new FileReader();
	    reader.onload = function(event) {
	        const data = new Uint8Array(event.target.result);
	        const workbook = XLSX.read(data, { type: 'array' });

	        // Convert the first sheet to JSON
	        const sheetToJson = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

	        // Determine the endpoint based on the selected template
	        let endpoint;
	        if (selectedTemplate === 'leave') {
	            endpoint = '/upload-leave';
	        } else if (selectedTemplate === 'timesheet') {
	            endpoint = '/upload-timesheet';
	        }

	        // Send JSON data to backend API
	        fetch(endpoint, {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/json' // Set the content type as JSON
	            },
	            body: JSON.stringify(sheetToJson) // Send JSON data as request body
	        })
	        .then(response => response.text())
	        .then(message => {
	            // Display success or failure message
	            alert(message);
	        })
	        .catch(error => {
	            console.error('Error:', error);
	            alert('An error occurred. Please try again.');
	        });
	    };
	    reader.readAsArrayBuffer(file); // Read file as array buffer
	});
        
	let data; // Declare data variable outside the scope of event listeners
    
    document.getElementById('generateReport').addEventListener('click', function() {
        const template = document.getElementById('templateName').value;
        const month = document.getElementById('reportMonth').value;
        const monthNames = ["January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"];

        let endpoint = '';

        if (template === 'leaveReport') {
            endpoint = `/fetch/leaveMonth/${monthNames[month - 1]}`;
        } else if (template === 'timesheet') {
            endpoint = `/Timesheets/leaveMonth/${monthNames[month - 1]}`;
        }

        fetch(endpoint)
            .then(response => {
                if (!response.ok) {
                    throw new Error('No records found  to fetch report');
                }
                return response.json();
            })
            .then(reportData => {
            	data = reportData; // Assign fetched data to global variable
                populateReportTable(data);
                attachDownloadEvent(); // Attach download event after data is populated
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message);
            });
    });

 // Function to download PDF
    function downloadPDF(data, fileName) {
        // Create a new jsPDF instance
        const doc = new jsPDF();

        // Convert data to an array of arrays
        const rows = data.map(rowData => Object.values(rowData));

        // Add a table to the PDF
        doc.autoTable({
            head: [Object.keys(data[0])],
            body: rows
        });

        // Save the PDF
        doc.save(fileName);
    }

   


    function populateReportTable(data) {
        const table = document.getElementById('reportTable');
        table.innerHTML = '';

        const headers = Object.keys(data[0]);
        const headerRow = document.createElement('tr');
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        table.appendChild(headerRow);

        data.forEach(rowData => {
            const row = document.createElement('tr');
            headers.forEach(header => {
                const td = document.createElement('td');
                td.textContent = rowData[header];
                row.appendChild(td);
            });
            table.appendChild(row);
        });
    }
    
 // Function to attach download event listener
    function attachDownloadEvent() {
        // Attach event listener to download button
        const downloadButton = document.getElementById('downloadLeaveReport');
        downloadButton.addEventListener('click', function() {
            const template = document.getElementById('templateName').value;
            let fileName = '';

            // Check if data is defined and not null
            if (data) {
                // If data is defined, determine filename and download the PDF
                if (template === 'leaveReport') {
                    fileName = 'leave_report.pdf';
                } else if (template === 'timesheet') {
                    fileName = 'timesheet.pdf';
                }
                downloadPDF(data, fileName);
            } else {
                // If data is not defined, log an error message
                console.error('Data is not defined. Make sure to populate data before downloading PDF.');
            }
        });

            
         // Log headers and data before generating PDF
            //console.log('Headers:', headers);
           // console.log('Data:', data);

            
            
            
            
         // Function to handle logout
            document.getElementById('logoutButton').addEventListener('click', function() {
                // Send POST request to backend logout API
                fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json' // Set content type to JSON
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to logout');
                    }
                    return response.json(); // Parse response as JSON
                })
                .then(data => {
                    // Redirect to login page
                    window.location.href = '/login.html'; // Replace with the actual URL of your login page
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error.message); // Display error message to the user
                });
            });
            
        }

        // Function to handle login response
        function handleLoginResponse(data) {
            if (data.message.includes('Login successful') && data.message.includes('admin')) {
                document.getElementById('uploadFormContainer').style.display = 'block';
                document.getElementById('leaveReportContainer').style.display = 'block';
            }
        }

        // Simulate login response from backend API
        // Replace this with actual response handling
        const fakeLoginResponse = {
            message: 'Login successful. User has admin role.'
        };
        handleLoginResponse(fakeLoginResponse);
    </script>
</body>
</html>