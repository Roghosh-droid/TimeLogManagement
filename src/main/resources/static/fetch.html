<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch Leave Report</title>
    <link rel="stylesheet" href="style.css">
    <script src="/jsPDF-1.3.2/dist/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
   
    
    
</head>
<body>
     <h1>Fetch Report</h1>
    <div id="reportContainer">
        <h2>Generate Report</h2>
        <label for="templateName">Select Template:</label>
        <select id="templateName">
            <option value="leaveReport">Leave Report</option>
            <option value="timesheet">Timesheet</option>
        </select>

        <label for="reportMonth">Select Month:</label>
        <select id="reportMonth">
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
        </select>

        <button id="generateReport">Generate</button>
        <button id="downloadLeaveReport">Download PDF</button>

        <table id="reportTable">
            <!-- Table headers and data will be dynamically populated -->
        </table>
    </div>

    <button id="logoutButton">Logout</button>

    <script>
    
    let data; // Declare data variable outside the scope of event listeners
    
        document.getElementById('generateReport').addEventListener('click', function() {
            const template = document.getElementById('templateName').value;
            const month = document.getElementById('reportMonth').value;
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];

            let endpoint = '';

            if (template === 'leaveReport') {
                endpoint = `/fetched/leaveMonth/${monthNames[month - 1]}`;
            } else if (template === 'timesheet') {
                endpoint = `/Timesheet/leaveMonth/${monthNames[month - 1]}`;
            }

            fetch(endpoint)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch report');
                    }
                    return response.json();
                })
                .then(reportData => {
                	data = reportData; // Assign fetched data to global variable
                    populateReportTable(data);
                    attachDownloadEvent(); // Attach download event after data is populated
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error.message);
                });
        });
    
     // Function to download PDF
        function downloadPDF(data, fileName) {
            // Create a new jsPDF instance
            const doc = new jsPDF();

            // Convert data to an array of arrays
            const rows = data.map(rowData => Object.values(rowData));

            // Add a table to the PDF
            doc.autoTable({
                head: [Object.keys(data[0])],
                body: rows
            });

            // Save the PDF
            doc.save(fileName);
        }

       


        function populateReportTable(data) {
            const table = document.getElementById('reportTable');
            table.innerHTML = '';

            const headers = Object.keys(data[0]);
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);

            data.forEach(rowData => {
                const row = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = rowData[header];
                    row.appendChild(td);
                });
                table.appendChild(row);
            });
        }
        
     // Function to attach download event listener
        function attachDownloadEvent() {
            // Attach event listener to download button
            const downloadButton = document.getElementById('downloadLeaveReport');
            downloadButton.addEventListener('click', function() {
                const template = document.getElementById('templateName').value;
                let fileName = '';

                // Check if data is defined and not null
                if (data) {
                    // If data is defined, determine filename and download the PDF
                    if (template === 'leaveReport') {
                        fileName = 'leave_report.pdf';
                    } else if (template === 'timesheet') {
                        fileName = 'timesheet.pdf';
                    }
                    downloadPDF(data, fileName);
                } else {
                    // If data is not defined, log an error message
                    console.error('Data is not defined. Make sure to populate data before downloading PDF.');
                }
            });
        }

        document.getElementById('logoutButton').addEventListener('click', function() {
            fetch('/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to logout');
                }
                return response.json();
            })
            .then(data => {
                window.location.href = '/login.html';
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message);
            });
        });
    </script>
</body>
</html>